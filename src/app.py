import streamlit as st
import base64
from pathlib import Path
import os


from src.utils.auth import get_user_data
from src.utils.config import APP_NAME, APP_VERSION

from pages import (
    info_page,
    registration_page,
    login_page,
    profile_page,
    upload_forecast_page,
    view_forecast_page,
    logout_page,
    user_list_page
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# App configuration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title=APP_NAME, page_icon="ğŸš€", layout="wide")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Session defaults
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.session_state.setdefault("logged_in", False)
st.session_state.setdefault("user_email", None)
st.session_state.setdefault("admin_editing_user", None)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Sidebar logo
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
logo_path = Path(__file__).parent / "images" / "logo-iph.png"
if logo_path.exists():
    st.logo(str(logo_path), size="large")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CSS per ingrandire il logo
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown(
    """
    <style>
    [data-testid="stSidebarLogo"] img {
        width: 200px !important;
        max-width: none !important;
    }
    </style>
    """,
    unsafe_allow_html=True
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Define pages
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info = st.Page(info_page.page, title="Info", icon="â„¹ï¸", url_path="/info")
registration = st.Page(registration_page.page, title="Register", icon="ğŸ§¾", url_path="/register")
login = st.Page(login_page.page, title="Login", icon="ğŸ”", url_path="/login")
profile = st.Page(profile_page.page, title="Profile", icon="ğŸ‘¤", url_path="/profile")
upload_forecast = st.Page(upload_forecast_page.page, title="Upload Forecast", icon="ğŸ¯", url_path="/upload_forecast")
view_forecast = st.Page(view_forecast_page.page, title="View Forecast", icon="ğŸ“Š", url_path="/view_forecast")
user_list = st.Page(user_list_page.page, title="User List", icon="ğŸ‘¥", url_path="/user_list")
logout = st.Page(logout_page.page, title="Logout", icon="ğŸšª", url_path="/logout")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Navigation logic basata sul ruolo
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if not st.session_state.get("logged_in"):
    menu_pages = [info, registration, login]
    account_pages = []
else:
    # Recupera il ruolo dell'utente loggato
    user_email = st.session_state.get("user_email")
    user = get_user_data(user_email) or {}
    user_role = user.get("role", "sales_role")
    
    account_pages = [profile, logout]
    if user_role == "admin_role":
        # Menu per admin
        menu_pages = [info, view_forecast, user_list]
    else:
        # Menu per sales_user (default)
        menu_pages = [info, upload_forecast, view_forecast]


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Render navigation
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
nav = st.navigation({"MenÃ¹": menu_pages}|{"Account": account_pages}, position="sidebar")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Gestione navigazione automatica per admin editing
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if st.session_state.get("admin_editing_user"):
    # Se l'admin sta editando un utente, forza la navigazione a Profile
    nav = st.navigation([profile], position="sidebar")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# User Profile nella sidebar (solo se loggato)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if st.session_state.get("logged_in") and st.session_state.get("user_email"):
    user_email = st.session_state["user_email"]
    user = get_user_data(user_email) or {}
    user_role = user.get("role", "sales_user")
    
    with st.sidebar:
        st.markdown("<br>", unsafe_allow_html=True)
        st.markdown(
            f"""
            <div style="background-color: #1e1e1e; padding: 15px; border-radius: 8px; margin-top: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #ffffff; font-size: 16px;">ğŸ‘¤ User Profile</h3>
                <p style="margin: 5px 0; font-size: 13px;">
                    <strong>ğŸ“§ Email:</strong><br>
                    <span style="color: #4CAF50;">{user_email}</span>
                </p>
                <p style="margin: 5px 0; font-size: 13px;">
                    <strong>ğŸ”‘ Role:</strong><br>
                    <span style="color: #2196F3;">{user_role}</span>
                </p>
            </div>
            """,
            unsafe_allow_html=True,
        )

nav.run()